/*! touch 2016-09-13 */
define(function(){return function(a,b){$("#container").load(a,function(){function a(){2==g&&e&&f&&$(".cart_table_wrap").html($("#emptycartTemplate").tmpl({}))}function b(){$(".cart_table li .select_span.active").length==$(".cart_table li .select_span").length?$("#all.select_span").addClass("active"):$("#all.select_span").removeClass("active")}function c(a){return a>=10?($.alertTmpMsg("单次购买商品数量不能超过10件。"),!1):!0}function d(){for(var a=$("#pj_table.cart_table ul li .select_span.active"),b=$("#yx_table.cart_table ul li .select_span.active"),c="0.00",d=0,e=a.length;e>d;d++){var f=a.eq(d).parents("li").find(".count-value input[type='text']").val();c=$.add([c,$.mul(a.eq(d).data("price"),f)],2)}for(var d=0,e=b.length;e>d;d++)c=$.add([c,b.eq(d).data("price")],2);$(".summary .myprice").text(c)}var e=!1,f=!1,g=0;Cart.getCartList(null,function(b){200==b.code?b.carts&&0!=b.carts.length?($("#pj_table.cart_table ul").html($("#cartTemplate").tmpl({list:b.carts})),d()):($("#pj_table").hide(),e=!0,g++,a()):$.alertTmpMsg(b.message)}),Game.gamePayList(null,function(b){200==b.code?b.data.cartlist&&0!=b.data.cartlist.length?($("#yx_table.cart_table ul").html($("#cartTemplate").tmpl({list:b.data.cartlist,ulist:b.data.ulist})),d(),$("#yx_table select").on("change",function(){var a=$(this);$(this).find("option:selected").val()&&($(this).siblings(".errmsg").fadeOut(100),Game.checkBuy({gid:a.data("gid"),productCode:a.data("produceid"),f_uid:a.find("option:selected").val()},function(b){200==b.code?1==b.is_buy?a.siblings(".errmsg").text("该角色已拥有此道具").fadeIn(100):a.siblings(".errmsg").fadeOut(100):a.siblings(".errmsg").text(b.message).fadeIn(100)}))})):($("#yx_table").hide(),f=!0,g++,a()):$.alertTmpMsg(b.message)}),$("#pj_table .all.select_span").on("click",function(){var a=$("#pj_table .all.select_span");a.toggleClass("active"),a.hasClass("active")?$("#pj_table.cart_table li .select_span").addClass("active"):($("#pj_table.cart_table li .select_span").removeClass("active"),$("#all .select_span").removeClass("active")),b(),d()}),$("#yx_table .all.select_span").on("click",function(){var a=$("#yx_table .all.select_span");a.toggleClass("active"),a.hasClass("active")?$("#yx_table.cart_table li .select_span").addClass("active"):$("#yx_table.cart_table li .select_span").removeClass("active"),b(),d()}),$("#all.select_span").on("click",function(){$(this).toggleClass("active"),$(this).hasClass("active")?$(".all.select_span,li .select_span").addClass("active"):$(".all.select_span,li .select_span").removeClass("active"),b(),d()}),$(".cart_table_wrap").on("click","li .select_span",function(){$(this).toggleClass("active"),$(this).parents(".cart_table").find("li .select_span.active").length==$(this).parents(".cart_table").find("li .select_span").length?$(this).parents(".cart_table").find(".all.select_span").addClass("active"):$(this).parents(".cart_table").find(".all.select_span").removeClass("active"),b(),d()}),$(".cart_table").on("click",".action",function(){var a={};a.content=$("#deleteWarnTemplate").tmpl({msg:"你确定要删除该商品吗？"}),a.width=450;var b=$(this);$.alertPop(a,function(){$(".dl_cancel").on("click",function(){$("#global_pop").hide()}),$(".dl_ok").on("click",function(){$("#global_pop").hide();var a=b.data("id");Cart.deleteCart({ids:a},function(c){"200"==c.code?(b.parent().find(".select_span").hasClass("active")&&$(".s_price").text($.sub($(".s_price").text(),$("#count_"+b.data("id")).text())),1==b.parents("ul").find("li").length&&b.parents(".cart_table").hide(),$("#li_"+a).remove(),$.setNum(c.data.goods_num),0==$(".cart_table li").length&&location.reload(),$.closeMsg()):$.alertTmpMsg(c.message)})})})}),$("#deleteAll").on("click",function(){var a={};a.content=$("#deleteWarnTemplate").tmpl({msg:"你确定要删除选中的商品吗？"}),a.width=450;var b=($(this),[]);return $(".cart_table_wrap .cart_table ul li .select_span.active").each(function(){b.push($(this).data("id"))}),0==b.length?($.alertTmpMsg("请选择要删除的商品。"),!1):void $.alertPop(a,function(){$(".dl_cancel").on("click",function(){$("#global_pop").hide()}),$(".dl_ok").on("click",function(){$("#global_pop").hide(),Cart.deleteCart({ids:b.join(",")},function(a){if("200"==a.code){var c=0;b.forEach(function(a){c=$.add([$("#count_"+a).text(),c],2),$("#li_"+a).remove()}),$(".s_price").text($.sub($(".s_price").text(),c)),0==$("#pj_table li").length&&$("#pj_table").hide(),0==$("#yx_table li").length&&$("#yx_table").hide(),$.setNum(a.data.goods_num),0==$(".cart_table li").length&&location.reload(),$.closeMsg()}else $.alertTmpMsg(a.message)})})})});var h=!0;$("#pj_table.cart_table").on("click",".subtract",function(){if(!h)return!1;var a=$(this),b=$(this).next().find(".count-input"),c=b.val();c>1&&(h=!1,Cart.addCart({cartlist:[{gid:$(this).data("gid"),g_a_flag:$(this).data("g_a_flag"),g_num:-1}]},function(d){if(h=!0,200==d.code){b.val(--c),$(".s_price").text($.sub($(".s_price").text(),a.data("price")));var e=$("#count_"+a.data("id"));e.text($.sub(e.text(),a.data("price"))),$(".su_total").text(parseInt($(".su_total").text())-1),$.setNum(d.data.goods_num)}else $.alertTmpMsg(d.message)}))});var i=!0;$("#pj_table.cart_table").on("click",".plus",function(){if(!i)return!1;var a=$(this),b=$(this).prev().find(".count-input"),d=b.val();c(d)&&i&&(i=!1,Cart.addCart({cartlist:[{gid:$(this).data("gid"),g_a_flag:$(this).data("g_a_flag"),g_num:1}]},function(c){if(i=!0,d=b.val(),200==c.code){b.val(++d),$(".s_price").text($.add([$(".s_price").text(),a.data("price")],2));var e=$("#count_"+a.data("id"));e.text($.add([e.text(),a.data("price")],2)),$(".su_total").text(parseInt($(".su_total").text())+1),$.setNum(c.data.goods_num)}else 500310==c.code&&$.alertTmpMsg(c.message)}))}),$("#pj_table.cart_table").on("input",".count-input",function(){var a=$(this).val().replace(/[^0-9]/gi,"");a=parseInt(a)?a:1,c(a)||(a=10),$(this).val(a);var b=$("#count_"+$(this).data("id"));b.text((JSON.parse($(this).data("price"))*a).toFixed(2));for(var d=0,e=$(".count span"),f=0,g=e.length;g>f;f++)d+=JSON.parse(e.eq(f).text());$(".s_price").text(d.toFixed(2)),Cart.addCart({cartlist:[{gid:$(this).data("gid"),g_a_flag:$(this).data("g_a_flag"),g_num:a,type:2}]},function(a){$.setNum(a.data.goods_num)})}),$(".gw_btn .btn").off().on("click","",function(){var a=!0,b=new Array,c=new Array;return $("#pj_table.cart_table ul li .select_span.active").each(function(){b.push({id:$(this).data("id")})}),$("#yx_table.cart_table ul li .select_span.active").each(function(){if(3==$(this).data("type")){var b=$(this).parents("li").find("option:selected").val(),d=$(this).parents("li").find("option:selected").text();0==b&&(a=!1,$(this).parents("li").find("select").siblings(".errmsg").text("请为角色选择道具").fadeIn(100)),c.push({id:$(this).data("id"),f_uid:b,f_name:d})}else c.push({id:$(this).data("id")})}),a?0==b.length&&0==c.length?($.alertTmpMsg("您未选择商品。"),!1):void($.getCookie("username")?Order.storeCartIds({ids:b,ids_g:c},function(a){if(200==a.code)$.goPage("createOrder");else if(500310==a.code){var b={};b.title="库存不足",b.content=$("#deleteWarnTemplate").tmpl({msg:a.message+",请您修改商品数量后，重新提交订单"}),b.width=500,$.alertPop(b,function(){$(".dl_cancel,.dl_ok").on("click",function(){$("#global_pop").hide()})})}else $.alertTmpMsg(a.message)}):window.location.href=Links.login+"?redirect="+encodeURIComponent(location.href)+"&broker=fuzemall&l=zh-cn"):!1})})}});